## æ¡†æ¶ç®€ä»‹

### ä¸‰å±‚æ¶æ„

è½¯ä»¶å¼€å‘å¸¸ç”¨çš„æ¶æ„æ˜¯ä¸‰å±‚æ¶æ„ï¼Œä¹‹æ‰€ä»¥æµè¡Œæ˜¯å› ä¸ºæœ‰ç€æ¸…æ™°çš„ä»»åŠ¡åˆ’åˆ†ã€‚ä¸€èˆ¬åŒ…æ‹¬ä»¥ä¸‹ä¸‰å±‚ï¼š

- æŒä¹…å±‚ï¼šä¸»è¦å®Œæˆä¸æ•°æ®åº“ç›¸å…³çš„æ“ä½œï¼Œå³å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ï¼Œä¹Ÿè¢«å«åšDAOå±‚ï¼ˆData Access Object ï¼‰
- ä¸šåŠ¡å±‚ï¼šä¸»è¦æ ¹æ®åŠŸèƒ½éœ€æ±‚å®Œæˆä¸šåŠ¡é€»è¾‘çš„å®šä¹‰å’Œå®ç°ï¼Œä¹Ÿè¢«å«åšServiceå±‚æˆ–Businesså±‚
- è¡¨ç°å±‚ï¼šä¸»è¦å®Œæˆä¸æœ€ç»ˆè½¯ä»¶ä½¿ç”¨ç”¨æˆ·çš„äº¤äº’ï¼Œéœ€è¦æœ‰äº¤äº’ç•Œé¢ã€‚ä¹Ÿè¢«å«åšwebå±‚æˆ–è€…Viewå±‚

ä¸‰å±‚æ¶æ„ä¹‹é—´è°ƒç”¨å…³ç³»ä¸ºï¼šè¡¨ç°å±‚è°ƒç”¨ä¸šåŠ¡å±‚ï¼Œä¸šåŠ¡å±‚è°ƒç”¨æŒä¹…å±‚

å±‚ä¸å±‚ä¹‹é—´çš„æ•°æ®äº¤äº’ï¼šä¸€èˆ¬ä½¿ç”¨javaå®ä½“å¯¹è±¡

### æ¡†æ¶

æ¡†æ¶å¯ä»¥ç†è§£ä¸ºåŠæˆå“è½¯ä»¶ï¼Œæ¡†æ¶åšå¥½ä»¥åï¼Œæ¥ä¸‹æ¥åœ¨å®ƒåŸºç¡€ä¸Šè¿›è¡Œå¼€å‘  

#### ä¸ºä»€ä¹ˆä½¿ç”¨æ¡†æ¶ï¼š

æ¡†æ¶å°è£…å¥½äº†ä¸€äº›å†—ä½™ï¼Œä¸”é‡ç”¨ç‡ä½çš„ä»£ç ã€‚å¹¶ä¸”ä½¿ç”¨åå°„ä¸åŠ¨æ€ä»£ç†æœºåˆ¶ï¼Œå°†ä»£ç å®ç°äº†é€šç”¨æ€§ï¼Œè®©å¼€å‘äººå‘˜æŠŠç²¾åŠ›ä¸“æ³¨åœ¨æ ¸å¿ƒçš„ä¸šåŠ¡ä»£ç å®ç°ä¸Š  

#### å¸¸è§çš„æ¡†æ¶

- æŒä¹…å±‚æ¡†æ¶ï¼šä¸“æ³¨äºè§£å†³æ•°æ®æŒä¹…åŒ–çš„æ¡†æ¶ã€‚å¸¸ç”¨çš„æœ‰mybatisã€hibernateã€spring jdbcç­‰ç­‰ã€‚
- è¡¨ç°å±‚æ¡†æ¶ï¼šä¸“æ³¨äºè§£å†³ä¸ç”¨æˆ·äº¤äº’çš„æ¡†æ¶ã€‚å¸¸è§çš„æœ‰struts2ã€spring mvcç­‰ç­‰ã€‚
- å…¨æ ˆæ¡†æ¶: èƒ½åœ¨å„å±‚éƒ½ç»™å‡ºè§£å†³æ–¹æ¡ˆçš„æ¡†æ¶ã€‚æ¯”è¾ƒè‘—åçš„å°±æ˜¯springã€‚  

> ä¼ä¸šä¸­æœ€å¸¸ç”¨çš„ç»„åˆï¼šSpring + Spring MVC + mybatisï¼ˆSSMï¼‰  

## Mybatisç®€ä»‹

### é—®é¢˜çš„å‡ºç°

åŸå§‹jdbcæ“ä½œé—®é¢˜ï¼š

- æ•°æ®åº“è¿æ¥åˆ›å»ºã€é‡Šæ”¾é¢‘ç¹é€ æˆç³»ç»Ÿèµ„æºæµªè´¹ä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½  
- sql è¯­å¥åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼Œé€ æˆä»£ç ä¸æ˜“ç»´æŠ¤  
- æŸ¥è¯¢æ“ä½œæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å°†ç»“æœé›†ä¸­çš„æ•°æ®æ‰‹åŠ¨å°è£…åˆ°å®ä½“ä¸­  

è§£å†³æ€è·¯ï¼š

- ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–è¿æ¥èµ„æº  
- å°†sqlè¯­å¥æŠ½å–åˆ°xmlé…ç½®æ–‡ä»¶ä¸­  
- ä½¿ç”¨åå°„ã€å†…çœç­‰åº•å±‚æŠ€æœ¯ï¼Œè‡ªåŠ¨å°†å®ä½“ä¸è¡¨è¿›è¡Œå±æ€§ä¸å­—æ®µçš„è‡ªåŠ¨æ˜ å°„  

### è§£å†³æ–¹æ¡ˆçš„ç»™å‡º

MyBatisæ˜¯ä¸€ä¸ªä¼˜ç§€çš„åŸºäºORMçš„åŠè‡ªåŠ¨è½»é‡çº§æŒä¹…å±‚æ¡†æ¶ï¼Œå®ƒå¯¹jdbcçš„æ“ä½œæ•°æ®åº“çš„è¿‡ç¨‹è¿›è¡Œå°è£…ï¼Œä½¿å¼€å‘è€…åªéœ€è¦å…³æ³¨ SQL æœ¬èº«ï¼Œè€Œä¸éœ€è¦èŠ±è´¹ç²¾åŠ›å»å¤„ç†ä¾‹å¦‚æ³¨å†Œé©±åŠ¨ã€åˆ›å»ºconnectionã€åˆ›å»ºstatementã€æ‰‹åŠ¨è®¾ç½®å‚æ•°ã€ç»“æœé›†æ£€ç´¢ç­‰jdbcç¹æ‚çš„è¿‡ç¨‹ä»£ç   

Githubåœ°å€ï¼šhttps://github.com/mybatis/mybatis-3/  

### ORMæ€æƒ³

ORMï¼ˆObject Relational Mappingï¼‰å¯¹è±¡å…³ç³»æ˜ å°„

- Oï¼ˆå¯¹è±¡æ¨¡å‹ï¼‰ï¼š

  å®ä½“å¯¹è±¡ï¼Œå³åœ¨ç¨‹åºä¸­æ ¹æ®æ•°æ®åº“è¡¨ç»“æ„å»ºç«‹çš„ä¸€ä¸ªä¸ªå®ä½“javaBean

- Rï¼ˆå…³ç³»å‹æ•°æ®åº“çš„æ•°æ®ç»“æ„ï¼‰ï¼š

  å…³ç³»æ•°æ®åº“é¢†åŸŸçš„Relationalï¼ˆå»ºç«‹çš„æ•°æ®åº“è¡¨ï¼‰

- Mï¼ˆæ˜ å°„ï¼‰ï¼š

  ä»Rï¼ˆæ•°æ®åº“ï¼‰åˆ°Oï¼ˆå¯¹è±¡æ¨¡å‹ï¼‰çš„æ˜ å°„ï¼Œå¯é€šè¿‡XMLæ–‡ä»¶æ˜ å°„  

å®ç°ï¼š

1. è®©å®ä½“ç±»å’Œæ•°æ®åº“è¡¨è¿›è¡Œä¸€ä¸€å¯¹åº”å…³ç³»  
   - å®ä½“ç±» <--> æ•°æ®åº“è¡¨
   - å®ä½“ç±»å±æ€§ <--> è¡¨é‡Œé¢å­—æ®µ
2. ä¸éœ€è¦ç›´æ¥æ“ä½œæ•°æ®åº“è¡¨ï¼Œç›´æ¥æ“ä½œè¡¨å¯¹åº”çš„å®ä½“ç±»å¯¹è±¡

ORMæ˜¯ä¸€ç§æ€æƒ³ï¼Œmybatisé‡‡ç”¨ORMæ€æƒ³è§£å†³äº†å®ä½“å’Œæ•°æ®åº“æ˜ å°„çš„é—®é¢˜ï¼Œå¯¹jdbc è¿›è¡Œäº†å°è£…ï¼Œå±è”½äº†jdbc api åº•å±‚è®¿é—®ç»†èŠ‚ï¼Œä»è€Œä¸ç”¨å…³å¿ƒjdbc api

## Mybatiså¿«é€Ÿå…¥é—¨

MyBatiså®˜ç½‘åœ°å€ï¼šhttp://www.mybatis.org/mybatis-3/

### Mybatiså¼€å‘æ­¥éª¤

æ¡ˆä¾‹éœ€æ±‚ï¼šé€šè¿‡mybatisæŸ¥è¯¢æ•°æ®åº“userè¡¨çš„æ‰€æœ‰è®°å½•ï¼Œå°è£…åˆ°Userå¯¹è±¡ä¸­ï¼Œæ‰“å°åˆ°æ§åˆ¶å°ä¸Š  

æ­¥éª¤åˆ†æï¼š

```markdown
1. åˆ›å»ºæ•°æ®åº“åŠuserè¡¨

2. åˆ›å»ºMavenå·¥ç¨‹ï¼Œå¯¼å…¥ä¾èµ–ï¼ˆMySQLé©±åŠ¨ã€mybatisã€junitï¼‰

3. ç¼–å†™Userå®ä½“ç±»  

4. ç¼–å†™UserMapper.xmlæ˜ å°„é…ç½®æ–‡ä»¶ï¼ˆORMæ€æƒ³ï¼‰  

5. ç¼–å†™sqlMapConfig.xmlæ ¸å¿ƒé…ç½®æ–‡ä»¶  
   - æ•°æ®åº“ç¯å¢ƒé…ç½®
   - æ˜ å°„å…³ç³»é…ç½®çš„å¼•å…¥(å¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶çš„è·¯å¾„)  

6. ç¼–å†™æµ‹è¯•ä»£ç  
   1. åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶
   2. è·å–sqlSessionFactoryå·¥å‚å¯¹è±¡
   3. è·å–sqlSessionä¼šè¯å¯¹è±¡
   4. æ‰§è¡Œsql
   5. æ‰“å°ç»“æœ
   6. é‡Šæ”¾èµ„æº  
```

### ä»£ç å®ç°

1. åˆ›å»ºuseræ•°æ®è¡¨

   ```mysql
   CREATE DATABASE `mybatis_db`;
   USE `mybatis_db`;
   
   CREATE TABLE `user` (
       `id` INT(11) NOT NULL AUTO_INCREMENT,
       `username` VARCHAR(32) NOT NULL COMMENT 'ç”¨æˆ·åç§°',
       `birthday` DATETIME DEFAULT NULL COMMENT 'ç”Ÿæ—¥',
       `sex` CHAR(1) DEFAULT NULL COMMENT 'æ€§åˆ«',
       `address` VARCHAR(256) DEFAULT NULL COMMENT 'åœ°å€',
   	PRIMARY KEY (`id`)
   ) ENGINE=INNODB DEFAULT CHARSET=utf8;
   
   -- insert....
   INSERT INTO `user`(`id`,`username`,`birthday`,`sex`,`address`) 
   VALUES (1,'å­æ…•','2020-11-11 00:00:00','ç”·','åŒ—äº¬æµ·æ·€'),
   	   (2,'åº”é¢ ','2020-12-12 00:00:00','ç”·','åŒ—äº¬æµ·æ·€');
   ```

2. å¯¼å…¥MyBatisçš„åæ ‡å’Œå…¶ä»–ç›¸å…³åæ ‡

   ```xml
   <!-- å¼•å…¥ç›¸å…³ä¾èµ– -->
   <dependencies>
       <!-- å¼•å…¥mybatisä¾èµ–  -->
       <dependency>
           <groupId>org.mybatis</groupId>
           <artifactId>mybatis</artifactId>
           <version>3.5.4</version>
       </dependency>
   
       <!-- å¼•å…¥mysqlé©±åŠ¨ -->
       <dependency>
           <groupId>mysql</groupId>
           <artifactId>mysql-connector-java</artifactId>
           <version>5.1.47</version>
       </dependency>
   
       <!-- å¼•å…¥junit -->
       <dependency>
           <groupId>junit</groupId>
           <artifactId>junit</artifactId>
           <version>4.13.1</version>
       </dependency>
   </dependencies>
   
   <!-- æŒ‡å®šç¼–ç å’Œç‰ˆæœ¬ -->
   <properties>
       <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
       <maven.compiler.encoding>UTF-8</maven.compiler.encoding>
       <maven.compiler.source>17</maven.compiler.source>
       <maven.compiler.target>17</maven.compiler.target>
   </properties>
   ```

3. ç¼–å†™Userå®ä½“  

   ```java
   public class User {
       private Integer id;
       private String username;
       private Date birthday;
       private String sex;
       private String address;
       // getter/setter ç•¥
   }
   ```

4. ç¼–å†™UserMapperæ˜ å°„æ–‡ä»¶

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <!DOCTYPE mapper
           PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
           "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="UserMapper">
       <select id="findAll" resultType="com.fusi.domain.User">
           select * from user
       </select>
   </mapper>
   ```

5. ç¼–å†™MyBatisæ ¸å¿ƒæ–‡ä»¶  

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <!DOCTYPE configuration
           PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
           "http://mybatis.org/dtd/mybatis-3-config.dtd">
   
   <configuration>
       <!--ç¯å¢ƒé…ç½®-->
       <environments default="mysql">
           <!--ä½¿ç”¨MySQLç¯å¢ƒ-->
           <environment id="mysql">
               <!--ä½¿ç”¨JDBCç±»å‹äº‹åŠ¡ç®¡ç†å™¨-->
               <transactionManager type="JDBC"></transactionManager>
   
               <!--ä½¿ç”¨è¿æ¥æ± -->
               <dataSource type="POOLED">
                   <property name="driver" value="com.mysql.jdbc.Driver" />
                   <property name="url" value="jdbc:mysql://127.0.0.1:3306
                         /mybatis_db?useSSL=false&characterEncoding=UTF-8" />
                   <property name="username" value="root" />
                   <property name="password" value="123456" />
               </dataSource>
           </environment>
       </environments>
   
       <mappers>
       	<mapper resource="com/fusi/mapper/UserMapper.xml"></mapper>
       </mappers>
   </configuration>
   ```

6. ç¼–å†™æµ‹è¯•ç±»  

   ```java
   @Test
   public void mybatisQuickStart() throws IOException {
       // åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶
       InputStream resourceAsStream = Resources.getResourceAsStream("sqlMapConfig.xml");
   
       // è·å–SqlSessionFactionå·¥å‚å¯¹è±¡
       SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(resourceAsStream);
   
       // è·å–sqlSessionå¯¹è±¡
       SqlSession sqlSession = sqlSessionFactory.openSession();
   
       // æ‰§è¡Œsql å‚æ•°ï¼šstatementid : namespace.id
       List<User> users = sqlSession.selectList("userMapper.findAll");
   
       // éå†æ‰“å°ç»“æœ
       for (User user : users) {
           System.out.println(user);
       }
   
       // å…³é—­èµ„æº
       sqlSession.close();
   }
   ```

## Mybatisæ˜ å°„æ–‡ä»¶æ¦‚è¿°  

![1-4](./MybatisåŸºç¡€.assets/1-4.png)

## Mybatiså¢åˆ æ”¹æŸ¥  

### å¢

#### ç¼–å†™æ˜ å°„æ–‡ä»¶UserMapper.xml  

```xml
<!--æ–°å¢-->
<insert id="save" parameterType="com.fusi.domain.User">
	insert into user(username,birthday,sex,address)
		values(#{username},#{birthday},#{sex},#{address})
</insert>
```

#### ç¼–å†™æµ‹è¯•ç±»

```java
@Test
public void testSave() throws Exception {
    // åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶
    InputStream is = Resources.getResourceAsStream("SqlMapConfig.xml");
    // è·å–SqlSessionFactoryå·¥å‚å¯¹è±¡
    SqlSessionFactory sqlSessionFactory = new
    SqlSessionFactoryBuilder().build(is);
    // è·å–SqlSessionä¼šè¯å¯¹è±¡
    SqlSession sqlSession = sqlSessionFactory.openSession();
    
    // åˆ›å»ºuserå®ä¾‹
    User user = new User();
    user.setUsername("jack");
    user.setBirthday(new Date());
    user.setSex("ç”·");
    user.setAddress("åŒ—äº¬æµ·æ·€");
    
    // æ‰§è¡Œsql
    sqlSession.insert("UserMapper.save", user);
    // DMLè¯­å¥ï¼Œæ‰‹åŠ¨æäº¤äº‹åŠ¡
    sqlSession.commit();
    // é‡Šæ”¾èµ„æº
    sqlSession.close();
}
```

#### æ³¨æ„äº‹é¡¹

```markdown
- æ’å…¥è¯­å¥ä½¿ç”¨insertæ ‡ç­¾
- åœ¨æ˜ å°„æ–‡ä»¶ä¸­ä½¿ç”¨ parameterType å±æ€§æŒ‡å®šè¦æ’å…¥çš„æ•°æ®ç±»å‹
- Sqlè¯­å¥ä¸­ä½¿ç”¨ #{å®ä½“å±æ€§å} æ–¹å¼å¼•ç”¨å®ä½“ä¸­çš„å±æ€§å€¼
- æ’å…¥æ“ä½œä½¿ç”¨çš„APIæ˜¯sqlSession.insert(â€œå‘½åç©ºé—´.idâ€,å®ä½“å¯¹è±¡);
- æ’å…¥æ“ä½œæ¶‰åŠæ•°æ®åº“æ•°æ®å˜åŒ–ï¼Œæ‰€ä»¥è¦æäº¤äº‹åŠ¡ï¼Œå³sqlSession.commit()
```

### ä¿®æ”¹

```xml
<!--ä¿®æ”¹-->
<update id="update" parameterType="com.fusi.domain.User">
    update user set username = #{username},birthday = #{birthday},
    sex = #{sex},address = #{address} where id = #{id}
</update>
```

```markdown
## æ³¨æ„äº‹é¡¹
- ä¿®æ”¹è¯­å¥ä½¿ç”¨updateæ ‡ç­¾
- ä¿®æ”¹æ“ä½œä½¿ç”¨çš„APIæ˜¯sqlSession.update(â€œå‘½åç©ºé—´.idâ€,å®ä½“å¯¹è±¡)
```

### åˆ é™¤

```xml
<!--åˆ é™¤-->
<delete id="delete" parameterType="java.lang.Integer">
	delete from user where id = #{id}
</delete>
```

```markdown
## æ³¨æ„äº‹é¡¹
- åˆ é™¤è¯­å¥ä½¿ç”¨deleteæ ‡ç­¾
- Sqlè¯­å¥ä¸­ä½¿ç”¨#{ä»»æ„å­—ç¬¦ä¸²}æ–¹å¼å¼•ç”¨ä¼ é€’çš„å•ä¸ªå‚æ•°
- åˆ é™¤æ“ä½œä½¿ç”¨çš„APIæ˜¯sqlSession.delete(â€œå‘½åç©ºé—´.idâ€,Object);
```

## Mybatisæ ¸å¿ƒæ–‡ä»¶æ¦‚è¿°  

### MyBatisæ ¸å¿ƒé…ç½®æ–‡ä»¶å±‚çº§å…³ç³»  

![image-20230228163826960](./MybatisåŸºç¡€.assets/image-20230228163826960.png)

### MyBatiså¸¸ç”¨é…ç½®è§£æ  

#### environmentsæ ‡ç­¾  

æ•°æ®åº“ç¯å¢ƒçš„é…ç½®ï¼Œæ”¯æŒå¤šç¯å¢ƒé…ç½®  

```xml
<!-- æŒ‡å®šé»˜è®¤çš„ç¯å¢ƒåç§° -->
<environments default="development">
    <!-- æŒ‡å®šå½“å‰ç¯å¢ƒçš„åç§° -->
    <environment id="development">
        <!-- æŒ‡å®šäº‹åŠ¡ç®¡ç†ç±»å‹æ˜¯JDBC -->
        <transactionManager type="JDBC"></transactionManager>

        <!-- ä½¿ç”¨è¿æ¥æ±  -->
        <dataSource type="POOLED">
              <property name="driver" value="${driver}"/>
              <property name="url" value="${url}"/>
              <property name="username" value="${username}"/>
              <property name="password" value="${password}"/>
        </dataSource>
        
    </environment>
</environments>
```

äº‹åŠ¡ç®¡ç†å™¨ï¼ˆtransactionManagerï¼‰ç±»å‹æœ‰ä¸¤ç§ï¼š
- JDBCï¼š
è¿™ä¸ªé…ç½®å°±æ˜¯ç›´æ¥ä½¿ç”¨äº†JDBC çš„æäº¤å’Œå›æ»šè®¾ç½®ï¼Œå®ƒä¾èµ–äºä»æ•°æ®æºå¾—åˆ°çš„è¿æ¥æ¥ç®¡ç†äº‹åŠ¡ä½œç”¨åŸŸã€‚
- MANAGEDï¼š
è¿™ä¸ªé…ç½®å‡ ä¹æ²¡åšä»€ä¹ˆã€‚å®ƒä»æ¥ä¸æäº¤æˆ–å›æ»šä¸€ä¸ªè¿æ¥ï¼Œè€Œæ˜¯è®©å®¹å™¨æ¥ç®¡ç†äº‹åŠ¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚
ä¾‹å¦‚ï¼šmybatisä¸springæ•´åˆåï¼Œäº‹åŠ¡äº¤ç»™springå®¹å™¨ç®¡ç†ã€‚

***

æ•°æ®æºï¼ˆdataSourceï¼‰å¸¸ç”¨ç±»å‹æœ‰ä¸‰ç§ï¼š

- UNPOOLEDï¼š

  è¿™ä¸ªæ•°æ®æºçš„å®ç°åªæ˜¯æ¯æ¬¡è¢«è¯·æ±‚æ—¶æ‰“å¼€å’Œå…³é—­è¿æ¥ã€‚  

- POOLEDï¼š
  è¿™ç§æ•°æ®æºçš„å®ç°åˆ©ç”¨â€œæ± â€çš„æ¦‚å¿µå°† JDBC è¿æ¥å¯¹è±¡ç»„ç»‡èµ·æ¥ã€‚

- JNDI :
  è¿™ä¸ªæ•°æ®æºå®ç°æ˜¯ä¸ºäº†èƒ½åœ¨å¦‚ EJB æˆ–åº”ç”¨æœåŠ¡å™¨è¿™ç±»å®¹å™¨ä¸­ä½¿ç”¨ï¼Œå®¹å™¨å¯ä»¥é›†ä¸­æˆ–åœ¨å¤–éƒ¨é…ç½®æ•°æ®æºï¼Œç„¶åæ”¾ç½®ä¸€ä¸ª JNDI ä¸Šä¸‹æ–‡çš„æ•°æ®æºå¼•ç”¨  

#### propertiesæ ‡ç­¾  

å®é™…å¼€å‘ä¸­ï¼Œä¹ æƒ¯å°†æ•°æ®æºçš„é…ç½®ä¿¡æ¯å•ç‹¬æŠ½å–æˆä¸€ä¸ªpropertiesæ–‡ä»¶ï¼Œè¯¥æ ‡ç­¾å¯ä»¥åŠ è½½é¢å¤–é…ç½®çš„propertiesï¼š  

- jdbc.properties

  ```properties
  jdbc.driver=com.mysql.jdbc.Driver
  jdbc.url=jdbc:mysql://127.0.0.1:3306/mybatis_db?useSSL=false
  jdbc.username=root
  jdbc.password=123456
  ```

- sqlMapConfig.xml

  ```xml
  <!--åŠ è½½propertiesæ–‡ä»¶-->
  <properties resource="jdbc.properties"></properties>
  
  <!-------------------------------------------------->
        <property name="driver" value="${jdbc.driver}"/>
        <property name="url" value="${jdbc.url}"/>
        <property name="username" value="${jdbc.username}"/>
        <property name="password" value="${jdbc.password}"/>
  <!-------------------------------------------------->
  ```

####  typeAliasesæ ‡ç­¾  

ç±»å‹åˆ«åæ˜¯ä¸º Java ç±»å‹è®¾ç½®ä¸€ä¸ªçŸ­çš„åå­—ã€‚
ä¸ºäº†ç®€åŒ–æ˜ å°„æ–‡ä»¶ Java ç±»å‹è®¾ç½®ï¼Œmybatisæ¡†æ¶ä¸ºæˆ‘ä»¬è®¾ç½®å¥½çš„ä¸€äº›å¸¸ç”¨çš„ç±»å‹çš„åˆ«åï¼š  

![image-20230228165048432](./MybatisåŸºç¡€.assets/image-20230228165048432.png)

é…ç½®typeAliases

- sqlMapConfig.xml

  ```xml
  <!-- è®¾ç½®åˆ«å-->
  <typeAliases>
      <!--ç»™å•ä¸ªç±»èµ·åˆ«å-->
      <typeAlias type="com.User" alias="user"></typeAlias>
      <!--ç»™æ•´ä¸ªåŒ…èµ·åˆ«å ä¸åŒºåˆ†å¤§å°å†™-->
      <package name="com.fusi.domain"/>
  </typeAliases>
  ```

- UserMapper.xml

  ```xml
  <!-- ä»¥å‰çš„æ–¹å¼ -->
  <select id="findUserById" parameterType="int" resultType="com.fusi.domain.User">
  
  <select id="findUserById" parameterType="int" resultType="user">
      select * from user where id = #{id}
  </select>
  ```

#### mappersæ ‡ç­¾  

è¯¥æ ‡ç­¾çš„ä½œç”¨æ˜¯åŠ è½½æ˜ å°„çš„ï¼ŒåŠ è½½æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š  

```xml
1. ä½¿ç”¨ç›¸å¯¹äºç±»è·¯å¾„çš„èµ„æºå¼•ç”¨ï¼Œä¾‹å¦‚ï¼š
<mapper resource="org/mybatis/builder/userMapper.xml"/>

2. ä½¿ç”¨å®Œå…¨é™å®šèµ„æºå®šä½ç¬¦ï¼ˆURLï¼‰ï¼Œä¾‹å¦‚ï¼š
<mapper url="file:///var/mappers/userMapper.xml"/>

ä¸‹é¢ä¸¤ç§mapperä»£ç†å¼€å‘ä¸­ä½¿ç”¨

3. ä½¿ç”¨æ˜ å°„å™¨æ¥å£å®ç°ç±»çš„å®Œå…¨é™å®šç±»åï¼Œä¾‹å¦‚ï¼š
<mapper class="org.mybatis.builder.userMapper"/>

4. å°†åŒ…å†…çš„æ˜ å°„å™¨æ¥å£å®ç°å…¨éƒ¨æ³¨å†Œä¸ºæ˜ å°„å™¨ï¼Œä¾‹å¦‚ï¼š
<package name="org.mybatis.builder"/>
```

## Mybatisçš„APIæ¦‚è¿°

1. `SqlSession`å·¥å‚æ„å»ºå™¨`SqlSessionFactoryBuilder`

   - å¸¸ç”¨APIï¼š`SqlSessionFactory build(InputStream inputStream) `

   - é€šè¿‡åŠ è½½Mabatisçš„æ ¸å¿ƒæ–‡ä»¶çš„è¾“å…¥æµçš„å½¢å¼æ„å»ºä¸€ä¸ªSqlSessionFactoryå¯¹è±¡

     ```java
     // è·å–èµ„æºè·¯å¾„
     String resource = "org/mybatis/builder/mybatis-config.xml";
     
     // åŠ è½½èµ„æºæ–‡ä»¶ï¼Œç”Ÿæˆä¸€ä¸ªæµå¯¹è±¡
     InputStream inputStream = Resources.getResourceAsStream(resource);
     
     // è·å–å·¥å‚çš„æ„é€ å¯¹è±¡
     SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();
     
     // å·¥å‚çš„æ„é€ å¯¹è±¡é€šè¿‡æµç”Ÿæˆå·¥å‚å¯¹è±¡
     SqlSessionFactory factory = builder.build(inputStream);
     ```

2. `SqlSession`å·¥å‚å¯¹è±¡`SqlSessionFactory  `

   - SqlSessionFactory æœ‰å¤šä¸ªä¸ªæ–¹æ³•åˆ›å»ºSqlSession å®ä¾‹ã€‚å¸¸ç”¨çš„æœ‰å¦‚ä¸‹ä¸¤ä¸ªï¼š  

     | æ–¹æ³•                            | è§£é‡Š                         |
     | ------------------------------- | ---------------------------- |
     | openSession()                   | é»˜è®¤æ‰‹åŠ¨æäº¤äº‹åŠ¡             |
     | openSession(boolean autoCommit) | å¦‚æœè®¾å®šä¸ºtrueï¼Œè‡ªåŠ¨æäº¤ä»»åŠ¡ |

3. `SqlSession`ä¼šè¯å¯¹è±¡ 

   - åŒ…å«æ‰€æœ‰æ‰§è¡Œè¯­å¥ã€æäº¤æˆ–å›æ»šäº‹åŠ¡å’Œè·å–æ˜ å°„å™¨å®ä¾‹çš„æ–¹æ³•  

     ```java
     <T> T selectOne(String statement, Object parameter)
     <E> List<E> selectList(String statement, Object parameter)
     int insert(String statement, Object parameter)
     int update(String statement, Object parameter)
     int delete(String statement, Object parameter)
     ```

   - æ“ä½œäº‹åŠ¡çš„æ–¹æ³•ä¸»è¦æœ‰ï¼š

     ```java
     void commit()
     void rollback()
     ```

## Mybatisçš„daoå±‚å¼€å‘ä½¿ç”¨  

### ä¼ ç»Ÿå¼€å‘æ–¹å¼ï¼š

1. ç¼–å†™UserMapperæ¥å£
2. ç¼–å†™UserMapperå®ç°
3. ç¼–å†™UserMapper.xml

ä¼ ç»Ÿæ–¹å¼é—®é¢˜ï¼š

1. å®ç°ç±»ä¸­ï¼Œå­˜åœ¨mybatisæ¨¡æ¿ä»£ç é‡å¤
2. å®ç°ç±»è°ƒç”¨æ–¹æ³•æ—¶ï¼Œxmlä¸­çš„sql statement ç¡¬ç¼–ç åˆ°javaä»£ç ä¸­  

è§£é¢˜æ€è·¯ï¼šåªå†™æ¥å£ï¼Œä¸å†™å®ç°ç±»ã€‚åªç¼–å†™æ¥å£å’ŒMapper.xmlå³å¯  

### ä»£ç†å¼€å‘æ–¹å¼

é‡‡ç”¨ Mybatis çš„åŸºäºæ¥å£ä»£ç†æ–¹å¼å®ç°æŒä¹…å±‚çš„å¼€å‘ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæ˜¯è¿›å…¥ä¼ä¸šçš„ä¸»æµ  

åŸºäºæ¥å£ä»£ç†æ–¹å¼çš„å¼€å‘åªéœ€è¦ç¨‹åºå‘˜ç¼–å†™ Mapper æ¥å£ï¼ŒMybatis æ¡†æ¶ä¼šåŠ¨æ€ç”Ÿæˆå®ç°ç±»çš„å¯¹è±¡  

**è¿™ç§å¼€å‘æ–¹å¼è¦æ±‚æˆ‘ä»¬éµå¾ªä¸€å®šçš„è§„èŒƒ**

- Mapper.xmlæ˜ å°„æ–‡ä»¶ä¸­çš„namespaceä¸mapperæ¥å£çš„å…¨é™å®šåç›¸åŒ

  ```sh
  main
  â”œâ”€â”€ java
  â”‚   â””â”€â”€ com
  â”‚       â””â”€â”€ fusi
  â”‚           â”œâ”€â”€ mapper
  â”‚           â”‚   â””â”€â”€ UserMapper.javağŸ”¸
  â”‚           â”œâ”€â”€ domain
  â”‚           â”‚   â””â”€â”€ User.java
  â”‚           â””â”€â”€ test
  â”‚               â””â”€â”€ MybatisTest.java
  â””â”€â”€ resources
      â”œâ”€â”€ com
      â”‚   â””â”€â”€ fusi
      â”‚       â””â”€â”€ mapper
      â”‚           â””â”€â”€ UserMapper.xmlğŸ”¸
      â”œâ”€â”€ jdbc.properties
      â””â”€â”€ sqlMapConfig.xml
  ```

- Mapperæ¥å£æ–¹æ³•åå’ŒMapper.xmlæ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰çš„æ¯ä¸ªstatementçš„idç›¸åŒ

- Mapperæ¥å£æ–¹æ³•çš„è¾“å…¥å‚æ•°ç±»å‹å’Œmapper.xmlæ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰çš„æ¯ä¸ªsqlçš„parameterTypeçš„ç±»å‹ç›¸åŒ

- Mapperæ¥å£æ–¹æ³•çš„è¾“å‡ºå‚æ•°ç±»å‹å’Œmapper.xmlæ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰çš„æ¯ä¸ªsqlçš„resultTypeçš„ç±»å‹ç›¸åŒ  

![image-20230301095032238](./MybatisåŸºç¡€.assets/image-20230301095032238.png)

1. ç¼–å†™UserMapperæ¥å£

   ```java
   public interface UserMapper {
   	public List<User> findAll() throws Exception;
   }
   ```

2. ç¼–å†™UserMapper.xml

   ```java
   <?xml version="1.0" encoding="UTF-8" ?>
   <!DOCTYPE mapper
       PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
       "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
   <mapper namespace="com.lagou.mapper.UserMapper">
       <!--æŸ¥è¯¢æ‰€æœ‰-->
       <select id="findAll" resultType="user">
       	select * from user
       </select>
   </mapper>
   ```

3. æµ‹è¯•

   ```java
   @Test
   public void test() throws IOException {
       // åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶
       InputStream resourceAsStream = Resources.getResourceAsStream("sqlMapConfig.xml");
       // è·å¾—SqlSessionFactoryå·¥å‚å¯¹è±¡
       SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(resourceAsStream);
       // è·å¾—SqlSessionä¼šè¯å¯¹è±¡
       SqlSession sqlSession = sqlSessionFactory.openSession();
   
       // è·å–Mapperä»£ç†å¯¹è±¡
       UserMapper mapper = sqlSession.getMapper(UserMapper.class);
       // æ‰§è¡ŒæŸ¥è¯¢
       User userById = mapper.findUserById(1);
       // é‡Šæ”¾èµ„æº
       System.out.println(userById);
   }
   ```

   

































